{% extends "products/layout.html" %} {% block content %}
<div class="max-w-2xl mx-auto">
  <div class="mb-8">
    <h1 class="text-4xl font-bold text-gray-900 mb-2">
      Formulario de Producto
    </h1>
    <p class="text-gray-600">
      Completa los campos para crear o actualizar un producto
    </p>
  </div>

  <div class="bg-white rounded-xl shadow-lg p-8">
    <form
      novalidate
      id="product_form"
      class="space-y-6"
      action="{% if product %}{% url 'products:update' product.id %}{% else %}{% url 'products:add' %}{% endif %}"
      method="post"
      enctype="multipart/form-data"
    >
      {% csrf_token %}
      <div>
        <label
          for="name"
          class="block text-sm font-semibold text-gray-700 mb-2"
        >
          Nombre del Producto
        </label>
        <input
          type="text"
          id="name"
          name="name"
          placeholder="Ej: Laptop Pro 15"
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-300"
          value="{{product.name}}"
        />
      </div>

      <div>
        <label
          for="price"
          class="block text-sm font-semibold text-gray-700 mb-2"
        >
          Precio ($)
        </label>
        <input
          type="number"
          id="price"
          name="price"
          placeholder="Ej: 1299.99"
          step="0.01"
          min="0"
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-300"
          value="{{product.price}}"
        />
      </div>
      <div>
        <label
          for="stock"
          class="block text-sm font-semibold text-gray-700 mb-2"
        >
          Stock
        </label>
        <input
          type="number"
          id="stock"
          placeholder="ej: 22"
          min="0"
          name="stock"
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-300"
          value="{{product.stock}}"
        />
      </div>
      <div>
        <span class="block text-sm font-semibold text-gray-700 mb-2"
          >Imagen</span
        >
        <label for="img">
          <div
            id="container-img"
            class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center bg-gray-50"
          >
            {% if product %}
            <img
              src="{{product.img.url}}"
              alt="{{product.name}}"
              class="mx-auto"
            />
            {% else %}
            <div id="preview" class="text-gray-500">
              <p class="text-sm">La vista previa de la imagen aparecerá aquí</p>
            </div>
            {% endif %}
          </div>
        </label>
        <input type="file" class="hidden" name="img" id="img" />
      </div>

      <div>
        <label
          for="description"
          class="block text-sm font-semibold text-gray-700 mb-2"
        >
          Descripción
        </label>
        <textarea
          id="description"
          name="description"
          placeholder="Describe las características y beneficios del producto..."
          rows="5"
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-300 resize-none"
        >
              {% if product %}
                   {{ product.description }}
               {% endif %}
      </textarea
        >
      </div>

      <div class="flex gap-4 pt-6">
        <button
          type="submit"
          class="flex-1 bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white font-semibold py-3 px-6 rounded-lg transition-all duration-300 hover:shadow-lg hover:scale-105"
        >
          {% if product %} Actualizar {% else %} Crear {% endif %}
        </button>
        <button
          type="reset"
          class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-3 px-6 rounded-lg transition-all duration-300"
        >
          {% if product %} Regresar {% else %} Limpiar Formulario {% endif %}
        </button>
        <a
          href="{% url 'products:lista' %}"
          class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-3 px-6 rounded-lg transition-all duration-300 flex items-center justify-center"
        >
          Cancelar
        </a>
      </div>
      <!-- ALERT -->
      <div id="container_error" class="w-full pt-3 min-h-[200px]"></div>
      <!--  -->
    </form>
  </div>
</div>

<script>
  document.getElementById("img").addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const container = document.getElementById("container-img");
    container.innerHTML = "";
    const img = document.createElement("img");
    img.src = URL.createObjectURL(file);
    container.appendChild(img);
    clearErrors("img");
  });
</script>
<script>
  document.getElementById("name").addEventListener("keyup", (e) => {
    const validationName = "name";
    clearErrors(validationName);
    const value = e.target.value;
    let errors = [];
    if (!value) errors.push("El nombre del producto no puede estar vacio");
    else if (desc.trim() == "") errors.push("El nombre no puede estar vacio");
    else if (value.length < 4)
      errors.push("El nombre del producto es de minimo 4 caracteres");
    errors.forEach((e) => {
      addError(e, validationName);
    });
  });
  document.getElementById("price").addEventListener("keyup", (e) => {
    const validationName = "price";
    clearErrors(validationName);
    const value = e.target.value;
    let errors = [];
    if (!value) errors.push("El precio no puede estar vacio");
    else if (value.trim() == "") errors.push("El precio no puede estar vacio");
    else if (isNaN(Number(value))) errors.push("El precio debe ser un numero");
    else if (Number(value) <= 0) errors.push("El precio debe ser mayor a 0");
    errors.forEach((e) => {
      addError(e, validationName);
    });
  });
  document.getElementById("stock").addEventListener("keyup", (e) => {
    const validationName = "stock";
    clearErrors(validationName);
    const value = e.target.value;
    let errors = [];
    if (!value) errors.push("El stock no puede estar vacio");
    else if (value.trim() == "") errors.push("El stock no puede estar vacio");
    else if (isNaN(Number(value))) errors.push("El stock debe ser un numero");
    else if (Number(value) <= 0) errors.push("El stock debe ser mayor a 0");
    errors.forEach((e) => {
      addError(e, validationName);
    });
  });
  document.getElementById("description").addEventListener("keyup", (e) => {
    const validationName = "description";
    clearErrors(validationName);
    const value = e.target.value;
    let errors = [];
    if (!value) errors.push("La descripcion no puede estar vacia");
    else if (value.trim() == "")
      errors.push("La descripcion no puede estar vacia");
    else if (value.length < 4)
      errors.push("La descripcion debe ser de minimo 4 caracteres");
    errors.forEach((e) => {
      addError(e, validationName);
    });
  });
</script>
<script>
  document.getElementById("product_form").addEventListener("submit", (e) => {
    clearErrors();
    const name = document.getElementById("name").value;
    const price = document.getElementById("price").value;
    const stock = document.getElementById("stock").value;
    const desc = document.getElementById("description").value;
    const img = document.getElementById("img").files[0];
    let errors = [];

    // NAME VALIDATION
    if (!name)
      errors.push({
        message: "El nombre del producto no puede estar vacio",
        type: "name",
      });
    else if (name.trim() == "")
      errors.push({ message: "El nombre no puede estar vacio", type: "name" });
    else if (name.length < 4)
      errors.push({
        message: "El nombre del producto es de minimo 4 caracteres",
        type: "name",
      });

    // PRICE VALIDATION
    if (!price)
      errors.push({ message: "El precio no puede estar vacio", type: "price" });
    else if (price.trim() == "")
      errors.push({ message: "El precio no puede estar vacio", type: "price" });
    else if (isNaN(Number(price)))
      errors.push({ message: "El precio debe ser un numero", type: "price" });
    else if (Number(price) <= 0)
      errors.push({ message: "El precio debe ser mayor a 0", type: "price" });

    // STOCK VALIDATION
    if (!stock)
      errors.push({ message: "El stock no puede estar vacio", type: "stock" });
    else if (stock.trim() == "")
      errors.push({ message: "El stock no puede estar vacio", type: "stock" });
    else if (isNaN(Number(stock)))
      errors.push({ message: "El stock debe ser un numero", type: "stock" });
    else if (Number(stock) <= 0)
      errors.push({ message: "El stock debe ser mayor a 0", type: "stock" });

    // IMG VALIDATIOn
    if (!img && !"{{product.name}}")
      errors.push({ message: "La imagen no puede estar vacia", type: "img" });

    // DESC VALIDATION
    if (!desc)
      errors.push({
        message: "La descripcion no puede estar vacia",
        type: "description",
      });
    else if (desc.trim() == "")
      errors.push({
        message: "La descripcion no puede estar vacia",
        type: "description",
      });
    else if (desc.length < 4)
      errors.push({
        message: "La descripcion debe ser de minimo 4 caracteres",
        type: "description",
      });

    errors.forEach((e) => {
      addError(e.message, e.type);
    });

    if (errors.length != 0) {
      e.preventDefault();
      return;
    }
  });
</script>
<script>
  const clearErrors = (type) => {
    const container = document.getElementById("container_error");
    if (!type) {
      container.innerHTML = "";
      return;
    }
    const errors = [...document.querySelectorAll(".item-error")];
    errors.forEach((cld) => {
      if (cld.classList.contains(`type-error-${type}`)) {
        console.log("removbe");
        cld.remove();
      }
    });
  };
  const addError = (message, type) => {
    const error = document.createElement("div");
    error.innerHTML = `<div
            class=" item-error type-error-${type} flex items-center p-4 mt-1 mb-4 text-red-800 rounded-lg bg-red-50 dark:bg-gray-800 dark:text-red-400"
          >
            <svg
              class="shrink-0 w-4 h-4"
              aria-hidden="true"
              xmlns="http://www.w3.org/2000/svg"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path
                d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5ZM9.5 4a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3ZM12 15H8a1 1 0 0 1 0-2h1v-3H8a1 1 0 0 1 0-2h2a1 1 0 0 1 1 1v4h1a1 1 0 0 1 0 2Z"
              />
            </svg>
            <div class="ms-3 text-sm font-medium" id="alert_error_text">
            ${message}
            </div>
            <button
              type="button"
              onclick="this.parentNode.remove()"
              class="ms-auto -mx-1.5 -my-1.5 bg-red-50 text-red-500 rounded-lg focus:ring-2 focus:ring-red-400 p-1.5 hover:bg-red-200 inline-flex items-center justify-center h-8 w-8 dark:bg-gray-800 dark:text-red-400 dark:hover:bg-gray-700"
            >
              <span class="sr-only">Close</span>
              <svg
                class="w-3 h-3"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 14 14"
              >
                <path
                  stroke="currentColor"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"
                />
              </svg>
            </button>
          </div>`;
    document.getElementById("container_error").appendChild(error);
  };
</script>
<script type="module">
  import autoAnimate from "https://cdn.jsdelivr.net/npm/@formkit/auto-animate@1.0.0-beta.1/index.min.js";
  const containter = document.getElementById("container_error");
  autoAnimate(containter);
</script>

<script type="module">
  import Toastify from "toastify-js";

  const mostrarPopup = (message) => {
    Toastify({
      text: message ?? "Default text",
      duration: 3000,
      close: true,
      gravity: "top", // `top` or `bottom`
      position: "right", // `left`, `center` or `right`
      stopOnFocus: true, // Prevents dismissing of toast on hover
      style: {
        background: "linear-gradient(to right, #00b09b, #96c93d)",
      },
      onClick: function () {}, // Callback after click
    }).showToast();
  };
</script>

{% if messages %} {% for message in messages %}
<script>
  mostrarPopup("{{message}}");
</script>
{% endfor %} {% endif %} {% endblock %}
